services:
  server:
    image: gitea/gitea:1.18.1
    container_name: gitea.localhost
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=sqlite3
      - GITEA__server__DISABLE_SSH=true
      - GITEA__server__OFFLINE_MODE=true
      - GITEA__security__INSTALL_LOCK=true
      - GITEA__service__DISABLE_REGISTRATION=true
      - GITEA__repository__ENABLE_PUSH_CREATE_USER=true
      - GITEA__repository__FORCE_PRIVATE=true
    restart: always
    volumes:
      - ./data/git:/data/git
      - ./data/gitea:/data/gitea
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3000:3000"
      - "222:22"
    networks:
      k3d-net:
        ipv4_address: 172.31.0.99
    healthcheck:
      test: ["CMD", "curl", "-f", "http://gitea.localhost:3000/api/healthz"]
      interval: 5s
      timeout: 5s
      retries: 20
  init:
    image: gitea/gitea:1.18.1
    container_name: gitea.init
    environment:
      - GITEA_APP_INI=/data/gitea/conf/app.ini
      - GITEA_CUSTOM=/data/gitea
      - GITEA_WORK_DIR=/data
      - GITEA_TEMP=/tmp/gitea
      - GITEA_ADMIN_USERNAME=git-user
      - GITEA_ADMIN_PASSWORD=superSecurePassword
      - GITEA_ADMIN_EMAIL=zarf@localhost
    user: 1000:1000
    command: /usr/sbin/configure-gitea.sh
    volumes:
      - ./configure-gitea.sh:/usr/sbin/configure-gitea.sh
      - ./data/gitea:/data/gitea
    depends_on:
      - server
  registry:
    image: registry:3
    container_name: registry.localhost
    environment:
      - REGISTRY_HTTP_ADDR=0.0.0.0:5001
      - REGISTRY_HTTP_DEBUG_ADDR=
      - REGISTRY_STORAGE_DELETE_ENABLED=true
      - REGISTRY_HTTP_SECRET=superSecurePassword
      - REGISTRY_AUTH=htpasswd
      - REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm
      - REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd
    volumes:
      - registry-auth:/auth
    ports:
      - "5001:5001"
    networks:
      - k3d-net
    depends_on:
      registry-init:
        condition: service_completed_successfully
  registry-init:
    image: httpd:2
    container_name: registry.init
    command: sh -c 'htpasswd -Bbn push-user superSecurePassword > /auth/htpasswd'
    volumes:
      - registry-auth:/auth

volumes:
  registry-auth:

networks:
  k3d-net:
    name: k3d-k3s-external-test
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.0.0/16
          gateway: 172.31.0.1
