kind: ZarfPackageConfig
metadata:
  name: distro-eks
  description: Deploy a EKS K8s cluster
  version: 0.0.3

values:
  files:
    - values.yaml

components:
  - name: load-eksctl
    required: true
    files:
      - source: eks.yaml
        target: eks.yaml
        template: true
      - source: https://github.com/eksctl-io/eksctl/releases/download/v0.214.0/eksctl_Darwin_amd64.tar.gz
        target: binaries/eksctl_Darwin_x86_64
        executable: true
        shasum: f154187b8497c80c490407e5fa7c90eb14fadeb996477a811725f319dc62d445
        extractPath: eksctl
      - source: https://github.com/eksctl-io/eksctl/releases/download/v0.214.0/eksctl_Darwin_arm64.tar.gz
        target: binaries/eksctl_Darwin_arm64
        executable: true
        shasum: 436a9b55cca31e1bdc9a4ad252ca2a95ab9ac98526db053798a181dec725f422
        extractPath: eksctl
      - source: https://github.com/eksctl-io/eksctl/releases/download/v0.214.0/eksctl_Linux_amd64.tar.gz
        target: binaries/eksctl_Linux_x86_64
        executable: true
        shasum: 0cd97a2b29b5b0143d22c62a952e39fd8909fb11f9f50095ca177ed08d756425
        extractPath: eksctl

  - name: deploy-eks-cluster
    description: Create an EKS cluster!
    actions:
      onDeploy:
        before:
          - cmd: ./binaries/eksctl_$(uname -s)_$(uname -m) create cluster --dry-run -f eks.yaml
          - cmd: sleep 15
          - cmd: ./binaries/eksctl_$(uname -s)_$(uname -m) create cluster -f eks.yaml
          - cmd: ./binaries/eksctl_$(uname -s)_$(uname -m) utils write-kubeconfig -c {{ .Values.cluster.name }}
            template: true

  - name: teardown-eks-cluster
    description: Delete the EKS cluster that this package was used to create.
    actions:
      onDeploy:
        before:
          - cmd: ./binaries/eksctl_$(uname -s)_$(uname -m) delete cluster -f eks.yaml --disable-nodegroup-eviction --wait
        after:
          # clean up after ourselves
          - cmd: rm -rf binaries
          - cmd: rm -f eks.yaml
