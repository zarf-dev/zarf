kind: ZarfPackageConfig
metadata:
  name: init-package-git-server

values:
  files:
    - values.yaml
  # TODO Schema

constants:
  - name: GITEA_IMAGE
    value: "###ZARF_PKG_TMPL_GITEA_IMAGE###"

components:
  - name: git-server
    description: |
      Deploys Gitea to provide git repositories for Kubernetes configurations.
      Required for GitOps deployments if no other git server is available.
    images:
      - "###ZARF_PKG_TMPL_GITEA_IMAGE###"
    manifests:
      - name: git-connect
        namespace: zarf
        files:
          - connect.yaml
    charts:
      - name: gitea
        releaseName: zarf-gitea
        url: oci://registry-1.docker.io/giteacharts/gitea
        version: 12.3.0
        namespace: zarf
        # TODO(mkcp): limit these to the specific values
        values:
          - sourcePath: "."
            targetPath: "."
    actions:
      onDeploy:
        before:
          - cmd: ./zarf internal update-gitea-pvc
            setValues:
              - key: .persistence.create
            mute: true
        after:
          - cmd: ./zarf internal create-read-only-gitea-user
            maxRetries: 3
            maxTotalSeconds: 60
            description: Create the read-only Gitea user
          - cmd: ./zarf internal create-artifact-registry-token
            maxRetries: 3
            maxTotalSeconds: 60
            description: Create an artifact registry token

        onFailure:
          - cmd: ./zarf internal update-gitea-pvc --rollback

# YAML keys starting with `x-` are custom keys that are ignored by the Zarf CLI
x-mdx: |
  The default setup for this package is to use a `rootless` image, specified in `gitea-values.yaml`. Because the gitea helm chart does its own appending of `-rootless` to the image tag, based on the `rootless` helm value, users don't need to supply the full image tag when overriding the default gitea image. Instead you need to use the `GITEA_SERVER_VERSION`, either in the zarf-config.toml or with `--set`.

  _Make sure, though, that the `x.x.x-rootless` tag does exist for Zarf to find._

  ```bash
  $ zarf package create . --set GITEA_IMAGE="custom.enterprise.corp/ironbank/opensource/gitea" \
    --set GITEA_SERVER_VERSION="v1.19.3"
  ```
